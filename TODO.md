# Auto-Docs Action TODO

## Project Overview
GitHub Action that automatically updates Python docstrings using Claude Code CLI. Uses subprocess for git operations, AST validation for safety, and retry logic for reliability.

## Development Environment ‚úÖ COMPLETED
- [x] Set up UV project with dependencies
- [x] Configure pre-commit (black, flake8, isort, mypy)
- [x] Install pytest + pytest-mock for testing
- [x] Project structure and CLAUDE.md documentation

## Core Implementation Tasks

### 1. Git Operations Module (`git_operations.py`)
**Pattern**: Follow pre-commit's subprocess approach for git commands

- [ ] **get_changed_py_files()**: Use `git diff --name-only HEAD~1 HEAD | grep '\.py$'`
- [ ] **get_file_diff(file_path)**: Use `git diff HEAD~1 HEAD <file_path>`
- [ ] **stage_file(file_path)**: Use `git add <file_path>`
- [ ] **restore_file(file_path)**: Use `git restore <file_path>` (clean retry state)
- [ ] **create_commit(message)**: Use `git commit -m <message>`
- [ ] **cmd_output() utility**: Subprocess wrapper with error handling like pre-commit

### 2. AST Validator (`ast_validator.py`)
**Purpose**: Mathematical proof that only docstrings changed

- [ ] **validate_changes()**: Compare original vs modified file AST trees
- [ ] **_extract_code_structure()**: Extract functions/classes without docstrings
- [ ] **_compare_structures()**: Verify signatures, logic, imports unchanged
- [ ] **_extract_docstrings()**: Get docstring nodes from AST
- [ ] **_compare_docstrings()**: Show what docstrings were added/modified
- [ ] **Handle syntax errors**: Return validation failure with error details

### 3. Claude Code Interface (`docstring_updater.py`)
**Command**: `claude -p <prompt> --output-format json --max-turns 3`

- [ ] **update_file()**: Main interface function
- [ ] **_build_claude_prompt()**: Template with file path, diff, constraints
- [ ] **_call_claude_cli()**: Subprocess with `["claude", "-p", prompt, "--output-format", "json"]`
- [ ] **_parse_response()**: Handle JSON output and error responses
- [ ] **Error handling**: Timeout (300s), subprocess errors, non-zero exit codes
- [ ] **Prompt template**: Emphasize "ONLY modify docstrings", Google-style format

### 4. File Processor (`file_processor.py`)
**Orchestrates**: Single file workflow with retry logic

- [ ] **process_file()**: Main orchestration function (max 2 retries)
- [ ] **Workflow loop**: capture_original ‚Üí update ‚Üí validate ‚Üí stage_or_restore
- [ ] **Retry logic**: If validation fails, `git restore` and retry
- [ ] **Operation logging**: Track all attempts and outcomes
- [ ] **Success criteria**: AST validation passes + file staged
- [ ] **Failure handling**: Exhaust retries ‚Üí log failure, continue to next file

### 5. Main Script (`main.py`)
**Entry point**: GitHub Action execution with rich logging

- [ ] **Environment setup**: Get INPUT_ANTHROPIC_API_KEY, INPUT_MAX_RETRIES
- [ ] **Claude Code environment**: Set ANTHROPIC_API_KEY env var
- [ ] **Main loop**: Get changed files ‚Üí process each ‚Üí create final commit
- [ ] **GitHub Actions outputs**: files_processed, files_successful, files_failed
- [ ] **Logging with emojis**: ü§ñ Starting, üìù Processing file, ‚úÖ Success, ‚ùå Failed
- [ ] **Final commit**: "docs: Update docstrings for N files\n\nAuto-generated by auto-docs-action"

### 6. GitHub Action Configuration (`action.yml`)
**Type**: Composite action using UV

- [ ] **Inputs**: anthropic_api_key (required), max_retries (default: 2)
- [ ] **Outputs**: files_processed, files_successful, files_failed
- [ ] **Steps**: Install UV ‚Üí UV sync ‚Üí Run main.py
- [ ] **Environment mapping**: INPUT_* variables to script
- [ ] **Shell**: bash for all steps
- [ ] **Infinite loop prevention**: Check if commit author is github-actions[bot]

### 7. Infinite Loop Prevention Strategy
**Problem**: When action commits changes, it triggers itself again
**Solutions**: Multiple approaches to prevent cycles

- [ ] **Method 1 - Commit Message Detection**: Add `[skip ci]` to commit messages
- [ ] **Method 2 - Actor Filtering**: Skip if `github.actor == 'github-actions[bot]'`
- [ ] **Method 3 - Branch Strategy**: Only run on specific events/branches
- [ ] **Method 4 - File Change Detection**: Skip if only auto-generated files changed
- [ ] **Implementation**: Add job-level `if` condition and commit message strategy

## Testing Implementation

### Test Structure (`tests/`)
```
tests/
‚îú‚îÄ‚îÄ conftest.py              # Shared fixtures (temp git repos, sample files)
‚îú‚îÄ‚îÄ test_data/              # Static test scenarios
‚îÇ   ‚îú‚îÄ‚îÄ python_samples/     # Various .py files for testing
‚îÇ   ‚îî‚îÄ‚îÄ expected_outputs/   # Known good results
‚îú‚îÄ‚îÄ unit/                   # Component tests
‚îÇ   ‚îú‚îÄ‚îÄ test_git_operations.py
‚îÇ   ‚îú‚îÄ‚îÄ test_ast_validator.py
‚îÇ   ‚îú‚îÄ‚îÄ test_docstring_updater.py
‚îÇ   ‚îî‚îÄ‚îÄ test_file_processor.py
‚îî‚îÄ‚îÄ integration/
    ‚îú‚îÄ‚îÄ test_main_workflow.py
    ‚îî‚îÄ‚îÄ test_retry_scenarios.py
```

### 7. Component Tests (Real Functionality, Minimal Mocking)

#### Git Operations Tests
- [ ] **Real git repos**: Use `tempfile` + `git.Repo.init()` for testing
- [ ] **Test get_changed_py_files()**: Create commits, verify correct .py files detected
- [ ] **Test restore_file()**: Modify file, restore, verify content reverted
- [ ] **Test stage/commit cycle**: Stage files, create commit, verify git history
- [ ] **Mock only subprocess calls**: Test command construction, not git logic

#### AST Validator Tests
- [ ] **Real Python parsing**: Use actual `ast.parse()` on real Python code
- [ ] **Logic change detection**: `return a + b` vs `return a - b` should fail validation
- [ ] **Docstring-only changes**: Adding docstrings should pass validation
- [ ] **Syntax error handling**: Malformed Python should return validation failure
- [ ] **Edge cases**: Decorators, nested classes, complex inheritance

#### Claude Code Interface Tests
- [ ] **Mock subprocess.run only**: Test command construction, response parsing
- [ ] **JSON response parsing**: Handle successful responses and error responses
- [ ] **Timeout handling**: Test subprocess timeout scenarios
- [ ] **Prompt template**: Verify prompt contains file path, diff, constraints

#### File Processor Integration Tests
- [ ] **Mock Claude Code calls**: Make realistic file modifications
- [ ] **Test retry logic**: First attempt fails validation ‚Üí restore ‚Üí retry succeeds
- [ ] **Test retry exhaustion**: All attempts fail ‚Üí log failure, continue
- [ ] **Operation logging**: Verify complete audit trail of attempts

### 8. Integration Testing
**Test complete main.py workflow in controlled environment**

- [ ] **Setup**: Create temp git repo, add Python files missing docstrings
- [ ] **Mock Claude Code**: Make realistic docstring additions to files
- [ ] **Run main()**: Execute complete workflow
- [ ] **Verify results**:
  - Files contain docstrings
  - Git commit created with proper message
  - AST validation confirms only docstrings changed
- [ ] **Test scenarios**: No files changed, partial success, all failures

### 9. Test Data Creation
- [ ] **conftest.py fixtures**: temp_git_repo, sample_python_files, mock_claude_responses
- [ ] **Sample Python files**: good_docstrings.py, missing_docstrings.py, syntax_error.py
- [ ] **Expected outputs**: Known good docstring additions for regression testing

### 10. CI/CD Integration
- [ ] **GitHub Actions workflow**: Run tests on push/PR
- [ ] **Test matrix**: Python 3.9, 3.10, 3.11, 3.12
- [ ] **Coverage reporting**: pytest-cov with coverage thresholds
- [ ] **Pre-commit integration**: Run on all commits

## Implementation Phases

### Phase 1: Core Components (Week 1)
1. **git_operations.py** - Subprocess git commands
2. **ast_validator.py** - AST comparison logic
3. **Basic tests** - Unit tests for both components

### Phase 2: Claude Integration (Week 2)
1. **docstring_updater.py** - Claude Code CLI interface
2. **file_processor.py** - Retry logic orchestration
3. **Integration tests** - Test components working together

### Phase 3: Main Workflow & Action (Week 3)
1. **main.py** - Complete workflow with logging
2. **action.yml** - GitHub Action configuration
3. **End-to-end tests** - Full workflow testing

### Phase 4: Polish & Documentation (Week 4)
1. **Error handling refinement** - Edge cases, better error messages
2. **Performance optimization** - Large repo handling
3. **Documentation** - README, usage examples, troubleshooting

## Success Criteria ‚úÖ

### Functional Requirements
- ‚úÖ **Detects changed .py files** correctly from git diff
- ‚úÖ **Updates docstrings** using Claude Code CLI
- ‚úÖ **Validates safety** via AST comparison (only docstrings changed)
- ‚úÖ **Handles failures gracefully** with retry logic and git restore
- ‚úÖ **Creates clean commits** with proper attribution

### Quality Requirements
- ‚úÖ **90%+ test coverage** across all components
- ‚úÖ **AST mathematical proof** of safety for every change
- ‚úÖ **Complete audit trail** of all operations
- ‚úÖ **Zero false positives** (files unchanged when no docstrings needed)
- ‚úÖ **Robust error handling** (network failures, syntax errors, etc.)

### Performance Requirements
- ‚úÖ **<5 minutes** for repos with <100 Python files
- ‚úÖ **Scales linearly** with number of changed files
- ‚úÖ **Minimal GitHub Actions usage** (efficient resource consumption)
